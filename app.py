import streamlit as st
import pandas as pd
import numpy as np
from scipy import stats
import plotly.express as px
import io

# ==========================
# C·∫•u h√¨nh trang
# ==========================
st.set_page_config(page_title="Ph√¢n T√≠ch ƒêi·ªÉm B·∫•t Th∆∞·ªùng", layout="wide", page_icon="üìä")

# Intro video
try:
    with open("test.mp4", "rb") as video_file:
        video_bytes = video_file.read()
    st.video(video_bytes)
except FileNotFoundError:
    st.warning("File test.mp4 not found. Skipping intro video.")

# Theme selection
theme = st.selectbox("Ch·ªçn theme", ["Original", "Castorice", "TealCoral"])

if theme == "Original":
    css = """
    <style>
        .main { background-color: #f0f2f6; }
        .stButton>button { background-color: #4CAF50; color: white; border-radius: 5px; }
        .stFileUploader>label { font-weight: bold; }
        .css-1d391kg { background-color: #ffffff; border-radius: 10px; padding: 20px; }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; }
        .stAlert { border-radius: 5px; }
        footer { visibility: hidden; }
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 10px;
        }
    </style>
    """
    primary_color = "#4CAF50"
    anomaly_color = "#FF5252"
    hist_normal = "#4CAF50"
    hist_anom = "#FF0000"
elif theme == "Castorice":
    css = """
    <style>
        .main { background-color: #e6e6fa; }  /* Lavender */
        .stButton>button { background-color: #c8a2c8; color: white; border-radius: 5px; }  /* Lilac */
        .stFileUploader>label { font-weight: bold; }
        .css-1d391kg { background-color: #f3e5f5; border-radius: 10px; padding: 20px; }  /* Light purple */
        h1 { color: #4b0082; }  /* Indigo */
        h2 { color: #6a1b9a; }  /* Purple */
        .stAlert { border-radius: 5px; }
        footer { visibility: hidden; }
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #4b0082;  /* Indigo */
            color: white;
            text-align: center;
            padding: 10px;
        }
    </style>
    """
    primary_color = "#c8a2c8"  # Lilac
    anomaly_color = "#9370db"  # Medium purple
    hist_normal = "#dda0dd"  # Plum
    hist_anom = "#4b0082"  # Indigo
else:  # TealCoral theme
    css = """
    <style>
        .main { background-color: #e0f7fa; }  /* Light teal background */
        .stButton>button { background-color: #008080; color: white; border-radius: 5px; }  /* Teal buttons */
        .stFileUploader>label { font-weight: bold; color: #ff6f61; }  /* Coral label */
        .css-1d391kg { background-color: #ffffff; border-radius: 10px; padding: 20px; border: 1px solid #008080; }  /* White card with teal border */
        h1 { color: #00695c; }  /* Dark teal headers */
        h2 { color: #ff6f61; }  /* Coral subheaders */
        .stAlert { border-radius: 5px; border: 1px solid #ff6f61; }  /* Coral alert border */
        footer { visibility: hidden; }
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #00695c;  /* Dark teal footer */
            color: white;
            text-align: center;
            padding: 10px;
        }
    </style>
    """
    primary_color = "#008080"  # Teal
    anomaly_color = "#ff6f61"  # Coral
    hist_normal = "#26a69a"  # Lighter teal
    hist_anom = "#d81b60"  # Darker coral

st.markdown(css, unsafe_allow_html=True)

# ==========================
# Header logo
# ==========================
col_logo, col_title = st.columns([1,6])
with col_logo:
    try:
        st.image("Logo_Marie_Curie.png", width=100)
    except:
        st.write("üè´ THPT Marie Curie")
with col_title:
    st.title("üìä Ph√¢n T√≠ch ƒêi·ªÉm S·ªë B·∫•t Th∆∞·ªùng S·ª≠ D·ª•ng Z-Score")

st.markdown("""
·ª®ng d·ª•ng ph√¢n t√≠ch ƒëi·ªÉm s·ªë b·∫•t th∆∞·ªùng d·ª±a tr√™n Z-score.  
- File CSV c·∫ßn c√≥ header: "MaHS", "Lop", c√°c c·ªôt m√¥n h·ªçc.  
- Z-score: ƒêi·ªÉm b·∫•t th∆∞·ªùng n·∫øu |z-score| > ng∆∞·ª°ng (m·∫∑c ƒë·ªãnh 2).  
- H·ªó tr·ª£ UTF-8.
""")

# ==========================
# Sidebar
# ==========================
with st.sidebar:
    st.header("üõ† C√†i ƒë·∫∑t")
    z_threshold = st.slider("Ng∆∞·ª°ng Z-Score", 1.0, 5.0, 2.0, 0.1)
    st.markdown("---")
    st.info("CSV ph·∫£i c√≥ c·ªôt s·ªë cho ƒëi·ªÉm v√† m√£ h√≥a UTF-8.")

# ==========================
# Upload file
# ==========================
uploaded_file = st.file_uploader("üìÇ Upload b·∫£ng ƒëi·ªÉm (CSV)", type="csv")
if uploaded_file is not None:
    # ƒê·ªçc file CSV
    try:
        df = pd.read_csv(uploaded_file, encoding='utf-8')
    except:
        uploaded_file.seek(0)
        df = pd.read_csv(uploaded_file, encoding='latin1')
        st.warning("File kh√¥ng ph·∫£i UTF-8, ƒë√£ d√πng latin1.")

    # Chu·∫©n h√≥a t√™n c·ªôt
    df.columns = df.columns.str.strip().str.replace(' ','').str.capitalize()

    # Ki·ªÉm tra c·ªôt l·ªõp
    class_col = [c for c in df.columns if c.lower()=='lop']
    if not class_col:
        st.error("Kh√¥ng t√¨m th·∫•y c·ªôt 'Lop'.")
        st.stop()
    df['Lop'] = df[class_col[0]]

    # Ki·ªÉm tra c·ªôt h·ªçc sinh
    student_col = [c for c in df.columns if c.lower() in ['mahs','id','studentid']]
    if not student_col:
        st.error("Kh√¥ng t√¨m th·∫•y c·ªôt 'MaHS'.")
        st.stop()
    df['MaHS'] = df[student_col[0]]

    # Ch·ªçn c√°c c·ªôt m√¥n h·ªçc
    subject_cols = [c for c in df.columns if c not in ['MaHS','Lop']]
    if len(subject_cols)==0:
        st.error("Kh√¥ng t√¨m th·∫•y c·ªôt ƒëi·ªÉm m√¥n h·ªçc.")
        st.stop()

    # Multi ch·ªçn l·ªõp + m√¥n
    classes = st.multiselect("Ch·ªçn l·ªõp ƒë·ªÉ l·ªçc", sorted(df['Lop'].unique()), default=sorted(df['Lop'].unique()))
    subjects = st.multiselect("Ch·ªçn m√¥n ƒë·ªÉ ph√¢n t√≠ch", subject_cols, default=subject_cols)

    df_filtered = df[df['Lop'].isin(classes)].copy()
    if df_filtered.empty:
        st.warning("Kh√¥ng c√≥ d·ªØ li·ªáu cho l·ªõp ƒë∆∞·ª£c ch·ªçn.")
        st.stop()

    # T√≠nh Z-score ri√™ng t·ª´ng m√¥n
    for subj in subjects:
        df_filtered[f'Z_{subj}'] = stats.zscore(df_filtered[subj].fillna(0))
        df_filtered[f'Highlight_{subj}'] = df_filtered[f'Z_{subj}'].abs() > z_threshold

    # ==========================
    # B·∫£ng d·ªØ li·ªáu
    # ==========================
    st.subheader("üìã B·∫£ng ƒëi·ªÉm g·ªëc v√† b·∫•t th∆∞·ªùng")
    col1, col2 = st.columns([3,1])

    with col1:
        st.write("**B·∫£ng g·ªëc h·ªçc sinh**")
        st.dataframe(df_filtered[['MaHS','Lop']+subjects], use_container_width=True)

        # T·∫°o b·∫£ng b·∫•t th∆∞·ªùng
        anomaly_cols = ['MaHS','Lop'] + [subj for subj in subjects]
        anomalies = df_filtered.copy()
        anomalies = anomalies[anomalies[[f'Highlight_{subj}' for subj in subjects]].any(axis=1)]
        st.write("**H·ªçc sinh b·∫•t th∆∞·ªùng**")
        st.dataframe(anomalies[anomaly_cols], use_container_width
